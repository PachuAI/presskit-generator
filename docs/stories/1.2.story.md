# Story 1.2: Sistema de Autenticación Completo

## Status
DONE

## Story
**Como** DJ o artista musical,
**Quiero** poder registrarme e iniciar sesión en ÍTERA PressKit Generator usando mi email/contraseña o Google OAuth,
**Para que** pueda acceder de forma segura a la plataforma y gestionar mis presskits con la confianza de que mi información está protegida

## Acceptance Criteria
1. Los usuarios deben poder registrarse usando email y contraseña con validación apropiada
2. Los usuarios deben poder registrarse usando Google OAuth como alternativa rápida
3. Los usuarios registrados deben poder iniciar sesión con sus credenciales
4. El sistema debe crear automáticamente un perfil de usuario tras el registro exitoso
5. Los usuarios deben poder cerrar sesión de forma segura
6. Las rutas protegidas deben requerir autenticación y redirigir apropiadamente
7. Las sesiones deben ser seguras y persistentes entre visitas del navegador
8. El middleware debe proteger todas las rutas /dashboard y /api/auth automáticamente

## Tasks / Subtasks

- [ ] Configurar Supabase Auth y servicios base (AC: 1, 2, 3, 7)
  - [ ] Crear proyecto en Supabase y configurar Auth
  - [ ] Configurar Google OAuth en Supabase Dashboard
  - [ ] Crear lib/supabase/client.ts para browser
  - [ ] Crear lib/supabase/server.ts para server-side
  - [ ] Configurar variables de entorno para Supabase

- [ ] Implementar AuthService centralizado (AC: 1, 2, 3, 5)
  - [ ] Crear lib/auth/auth-service.ts con métodos signup, signin, signout
  - [ ] Implementar signUpWithEmail con validación
  - [ ] Implementar signUpWithGoogle para OAuth
  - [ ] Implementar signInWithEmail con manejo de errores
  - [ ] Implementar signInWithGoogle para OAuth login
  - [ ] Implementar signOut con limpieza de sesión

- [ ] Crear esquema de base de datos user_profiles (AC: 4)
  - [ ] Ejecutar script SQL para crear tabla user_profiles
  - [ ] Configurar Row Level Security (RLS) policies
  - [ ] Implementar trigger para auto-creación de perfil
  - [ ] Configurar función de updated_at automático
  - [ ] Verificar integración con auth.users

- [ ] Implementar UserService para gestión de perfiles (AC: 4)
  - [ ] Crear lib/services/user-service.ts
  - [ ] Implementar createUserProfile automático post-registro
  - [ ] Implementar getUserProfile con validación de auth
  - [ ] Implementar updateUserProfile con sanitización
  - [ ] Configurar Zod schemas para validación de datos

- [ ] Configurar middleware de protección de rutas (AC: 6, 8)
  - [ ] Crear src/middleware.ts con protección automática
  - [ ] Implementar verificación de sesión en server-side
  - [ ] Configurar redirecciones: no-auth → /login, auth → /dashboard
  - [ ] Proteger rutas /dashboard/* automáticamente
  - [ ] Proteger rutas /api/auth/* y APIs privadas

- [ ] Implementar sistema de tipos TypeScript (AC: 1-8)
  - [ ] Crear types/auth.ts con interfaces de autenticación
  - [ ] Crear types/database.ts con tipos de DB
  - [ ] Generar tipos automáticos desde Supabase
  - [ ] Configurar tipos para sesiones y usuarios
  - [ ] Asegurar type safety en todo el flujo auth

- [ ] Crear hooks personalizados para manejo de auth (AC: 3, 5, 6, 7)
  - [ ] Crear hooks/use-auth.ts con estado global
  - [ ] Implementar useUser para obtener datos del usuario
  - [ ] Implementar useSession para manejo de sesiones
  - [ ] Configurar loading states y error handling
  - [ ] Implementar persistencia automática de sesiones

- [ ] Implementar API routes para autenticación (AC: 1, 2, 3, 5)
  - [ ] Crear app/api/auth/signup/route.ts con validación completa
  - [ ] Crear app/api/auth/signin/route.ts con error handling
  - [ ] Crear app/api/auth/signout/route.ts con limpieza
  - [ ] Crear app/auth/callback/route.ts para OAuth
  - [ ] Implementar manejo unificado de errores API

## Dev Notes

### Configuración Supabase Requerida
[Source: docs/architecture/tech-stack.md, docs/architecture/database-schema.md]

**Servicios Supabase a configurar:**
- **Database:** PostgreSQL 15+ con ACID compliance y JSON support
- **Authentication:** Supabase Auth built-in con OAuth y RLS integration  
- **OAuth Provider:** Google OAuth configurado

**Variables de entorno necesarias:**
```
NEXT_PUBLIC_SUPABASE_URL=tu-proyecto.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=public-anon-key
SUPABASE_SERVICE_ROLE_KEY=service-role-key
```

### Esquema de Base de Datos
[Source: docs/architecture/9-database-schema.md]

**Tabla user_profiles a crear:**
```sql
CREATE TABLE user_profiles (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    auth_user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    email TEXT NOT NULL UNIQUE,
    artist_name TEXT NOT NULL,
    full_name TEXT,
    avatar_url TEXT,
    bio TEXT,
    subscription_status TEXT NOT NULL DEFAULT 'free' 
        CHECK (subscription_status IN ('free', 'pro', 'enterprise')),
    presskit_limit INTEGER NOT NULL DEFAULT 3,
    social_media JSONB DEFAULT '{}',
    contact_email TEXT,
    phone TEXT,
    location TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**RLS Policies obligatorias:**
```sql
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view their own profile" ON user_profiles FOR SELECT USING (auth.uid() = auth_user_id);
CREATE POLICY "Users can update their own profile" ON user_profiles FOR UPDATE USING (auth.uid() = auth_user_id);
CREATE POLICY "Users can insert their own profile" ON user_profiles FOR INSERT WITH CHECK (auth.uid() = auth_user_id);
```

### APIs de Autenticación
[Source: docs/architecture/8-rest-api-specification.md]

**Endpoints a implementar:**

1. **POST /api/auth/signup**
   - Request: `{ email, password, artist_name }`
   - Response: `{ success: true, data: { user, session } }`
   - Error: `{ success: false, error_code: "VALIDATION_ERROR", message: "..." }`

2. **POST /api/auth/signin**  
   - Request: `{ email, password }`
   - Response: `{ success: true, data: { user, session } }`
   
3. **GET /api/users/profile**
   - Headers: `Authorization: Bearer jwt-token`
   - Response: Profile completo del usuario autenticado

**Formato de error unificado obligatorio:**
```typescript
{
  success: false,
  error_code: "VALIDATION_ERROR" | "AUTHENTICATION_ERROR" | etc.,
  message: "Human readable message",
  details?: { field: "specific errors" }
}
```

### Estructura de Archivos
[Source: docs/architecture/source-tree-structure.md]

**Ubicaciones exactas para implementación:**

```
src/
├── lib/
│   ├── supabase/
│   │   ├── client.ts         # Cliente Supabase browser
│   │   ├── server.ts         # Cliente Supabase server
│   │   └── middleware.ts     # Helpers para middleware
│   ├── auth/
│   │   ├── auth-service.ts   # Servicio centralizado auth
│   │   └── auth-helpers.ts   # Utilidades auth
│   └── services/
│       └── user-service.ts   # CRUD de perfiles usuario
├── hooks/
│   └── use-auth.ts           # Hook personalizado auth
├── types/
│   ├── auth.ts               # Tipos autenticación
│   └── database.ts           # Tipos generados Supabase
├── middleware.ts             # Middleware Next.js
└── app/
    ├── api/
    │   ├── auth/
    │   │   ├── signup/route.ts
    │   │   ├── signin/route.ts
    │   │   └── signout/route.ts
    │   └── users/
    │       └── profile/route.ts
    └── auth/
        └── callback/route.ts  # OAuth callback
```

### Estándares de Código Obligatorios
[Source: docs/architecture/coding-standards.md]

**Validación de entrada obligatoria:**
```typescript
import { z } from 'zod';
import DOMPurify from 'isomorphic-dompurify';

const SignupSchema = z.object({
  email: z.string().email('Email inválido'),
  password: z.string().min(8, 'Contraseña muy corta'),
  artist_name: z.string()
    .min(2, 'Nombre muy corto')
    .max(100, 'Nombre muy largo')
    .transform(input => DOMPurify.sanitize(input, { ALLOWED_TAGS: [] }))
});
```

**Manejo de errores obligatorio:**
- Todas las respuestas API deben usar el wrapper de errores unificado
- NUNCA usar console.log - usar structured logger  
- Secrets NUNCA hardcodeados - solo via environment variables
- Autenticación REQUERIDA en middleware para rutas protegidas

### Configuración Middleware
[Source: docs/architecture/source-tree-structure.md]

**src/middleware.ts debe implementar:**
```typescript
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs';
import { NextResponse } from 'next/server';

export async function middleware(req: NextRequest) {
  const res = NextResponse.next();
  const supabase = createMiddlewareClient({ req, res });
  const { data: { session } } = await supabase.auth.getSession();
  
  // Protect /dashboard routes
  if (req.nextUrl.pathname.startsWith('/dashboard') && !session) {
    return NextResponse.redirect(new URL('/login', req.url));
  }
  
  // Redirect authenticated users from auth pages
  if ((req.nextUrl.pathname === '/login' || req.nextUrl.pathname === '/register') && session) {
    return NextResponse.redirect(new URL('/dashboard', req.url));
  }
  
  return res;
}

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)']
};
```

### Testing

#### Estrategia de Testing
[Source: docs/architecture/14-test-strategy.md]

**Tests requeridos:**
- **Unit tests:** AuthService (signup, signin, signout)
- **Unit tests:** UserService (profile CRUD)
- **Integration tests:** Flujo completo registro → login → profile
- **E2E tests:** User journey completo con Playwright

**Ubicación de tests:**
- Unit: `tests/unit/services/auth-service.test.ts`
- Unit: `tests/unit/services/user-service.test.ts` 
- Integration: `tests/integration/auth-flow.test.ts`
- E2E: `tests/e2e/auth.spec.ts`

**Testing de autenticación obligatorio:**
```typescript
// Ejemplo test AuthService
describe('AuthService', () => {
  describe('signUpWithEmail', () => {
    it('should create user and profile successfully', async () => {
      const result = await AuthService.signUpWithEmail({
        email: 'test@example.com',
        password: 'password123',
        artist_name: 'Test Artist'
      });
      
      expect(result.success).toBe(true);
      expect(result.data.user).toBeDefined();
      expect(result.data.session).toBeDefined();
    });
  });
});
```

### Seguridad y Performance
- **Rate limiting:** Implementar en API endpoints de auth
- **CSRF protection:** Configurado automáticamente por Supabase
- **Session security:** Tokens JWT seguros con refresh automático
- **RLS enforcement:** Todas las queries usan RLS automáticamente

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-06 | 1.0 | Historia inicial del sistema de autenticación | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be completed by dev agent*

### Debug Log References
*To be completed by dev agent*

### Completion Notes List
*To be completed by dev agent*

### File List
*To be completed by dev agent*

## QA Results
*Results from QA Agent review will be populated here after implementation*